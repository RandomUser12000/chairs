#!/usr/bin/env bash

deluser --remove-home penguru 2>/dev/null
gpasswd -d ham sudo 2>/dev/null
chage -M 90 noir 2>/dev/null
addgroup spider 2>/dev/null
gpasswd -M may,peni,stan,miguel spider 2>/dev/null
passwd -l root 2>/dev/null

sed -i 's/\(password.*pam_unix.so.*yescrypt\)/\1 minlen=10/' /etc/pam.d/common-password
sed -i 's/\(password.*pam_unix.so.*minlen=10\)/\1 remember=3/' /etc/pam.d/common-password

cat >/usr/share/pam-configs/faillock <<'EOF'
Name: Lockout on failed logins
Default: no
Priority: 0
Auth-Type: Primary
Auth:
[default=die] pam_faillock.so authfail
EOF

cat >/usr/share/pam-configs/faillock_reset <<'EOF'
Name: Reset lockout on success
Default: no
Priority: 0
Auth-Type: Additional
Auth:
required pam_faillock.so authsucc
EOF

cat >/usr/share/pam-configs/faillock_notify <<'EOF'
Name: Notify on account lockout
Default: no
Priority: 1024
Auth-Type: Primary
Auth:
requisite pam_faillock.so preauth
EOF

DEBIAN_FRONTEND=noninteractive pam-auth-update \
  --enable faillock \
  --enable faillock_reset \
  --enable faillock_notify 2>/dev/null

sed -i 's/ nullok//g' /etc/pam.d/common-auth

# Enable full ASLR (Address Space Layout Randomization) persistently
if grep -q "^[[:space:]]*kernel.randomize_va_space[[:space:]]*=" /etc/sysctl.conf; then
  sed -i 's/^[[:space:]]*kernel.randomize_va_space[[:space:]]*=.*/kernel.randomize_va_space = 2/' /etc/sysctl.conf
else
  echo "kernel.randomize_va_space = 2" >> /etc/sysctl.conf
fi

# Ensure TCP SYN cookies are enabled
if grep -q "^[[:space:]]*net.ipv4.tcp_syncookies[[:space:]]*=" /etc/sysctl.conf; then
  sed -i 's/^[[:space:]]*net.ipv4.tcp_syncookies[[:space:]]*=.*/net.ipv4.tcp_syncookies = 1/' /etc/sysctl.conf
else
  echo "net.ipv4.tcp_syncookies = 1" >> /etc/sysctl.conf
fi

# Apply sysctl changes
sysctl --system >/dev/null 2>&1

ufw --force enable >/dev/null 2>&1

systemctl disable --now nginx 2>/dev/null
systemctl disable --now squid 2>/dev/null

sed -i '/allow-guest=false/d' /etc/lightdm/lightdm.conf 2>/dev/null
echo "allow-guest=false" >> /etc/lightdm/lightdm.conf 2>/dev/null

if [ -d /srv/ftp ]; then
  chmod 755 /srv/ftp
  chown root:root /srv/ftp
fi
if [ -d /var/ftp ]; then
  chmod 755 /var/ftp
  chown root:root /var/ftp
fi

systemctl disable --now ssh 2>/dev/null
systemctl disable --now sshd 2>/dev/null

if [ -f /etc/apt/apt.conf.d/10periodic ]; then
  sed -i 's/APT::Periodic::Update-Package-Lists.*/APT::Periodic::Update-Package-Lists "1";/' /etc/apt/apt.conf.d/10periodic
else
  echo 'APT::Periodic::Update-Package-Lists "1";' > /etc/apt/apt.conf.d/10periodic
fi

apt-get install -y unattended-upgrades 2>/dev/null
echo 'APT::Periodic::Unattended-Upgrade "1";' >> /etc/apt/apt.conf.d/10periodic
dpkg-reconfigure -plow unattended-upgrades 2>/dev/null

sed -i 's|//\s*"\${distro_id}:\${distro_codename}-security";|"\${distro_id}:\${distro_codename}-security";|' \
  /etc/apt/apt.conf.d/50unattended-upgrades 2>/dev/null

apt-get update 2>/dev/null
DEBIAN_FRONTEND=noninteractive apt-get full-upgrade -y 2>/dev/null

find /home -name "*.mp3" -type f -delete 2>/dev/null
find /home -name "*.ogg" -type f -delete 2>/dev/null

rm -f /usr/games/pyrdp-master.zip 2>/dev/null
find / -name "pyrdp-master.zip" -type f -delete 2>/dev/null

apt-get purge -y amule amule-common 2>/dev/null
apt-get purge -y wireshark wireshark-common 2>/dev/null
apt-get purge -y zangband 2>/dev/null
apt-get purge -y doona xprobe 2>/dev/null
apt-get autoremove -y 2>/dev/null
apt-get autoclean -y 2>/dev/null

rm -f /usr/share/zod/kneelB4zod.py 2>/dev/null
pkill -f kneelB4zod.py 2>/dev/null

if [ -f /etc/vsftpd.conf ]; then
  cp /etc/vsftpd.conf /etc/vsftpd.conf.backup
  sed -i 's/^ssl_enable=.*/ssl_enable=YES/' /etc/vsftpd.conf
  if ! grep -q "^ssl_enable" /etc/vsftpd.conf; then
    echo "ssl_enable=YES" >> /etc/vsftpd.conf
  fi
  if ! grep -q "^rsa_cert_file" /etc/vsftpd.conf; then
    {
      echo "rsa_cert_file=/etc/ssl/certs/ssl-cert-snakeoil.pem"
      echo "rsa_private_key_file=/etc/ssl/private/ssl-cert-snakeoil.key"
      echo "ssl_tlsv1=YES"
      echo "ssl_sslv2=NO"
      echo "ssl_sslv3=NO"
      echo "require_ssl_reuse=NO"
      echo "ssl_ciphers=HIGH"
    } >> /etc/vsftpd.conf
  fi
  systemctl restart vsftpd 2>/dev/null
fi

echo "Done"



